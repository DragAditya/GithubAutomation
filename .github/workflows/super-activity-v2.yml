name: Super Activity Engine V2

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  human-sim:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Git Identity
        run: |
          git config --global user.name "dragaditya"
          git config --global user.email "waghaditya312@gmail.com"

      # ----------------------
      # Session Warmup Delay
      # ----------------------
      - name: Warmup Delay
        run: sleep $((RANDOM % 4200))

      # ----------------------
      # Mode Selector (Weighted)
      # ----------------------
      - name: Select Mode
        id: mode
        run: |
          R=$((RANDOM % 100))
          if [ $R -lt 50 ]; then MODE="commit";
          elif [ $R -lt 80 ]; then MODE="branch_pr";
          else MODE="issue"; fi
          echo "MODE=$MODE" >> $GITHUB_OUTPUT

      # ----------------------
      # Smart Commit Burst
      # ----------------------
      - name: Commit Burst
        if: steps.mode.outputs.MODE == 'commit'
        run: |
          MSGS=(
            "refactor: internal cleanup"
            "perf: optimize flow"
            "fix: minor logic issue"
            "docs: update notes"
            "chore: structure improve"
          )

          FILES=("activity.log" "dev.md" "trace.txt")

          COUNT=$((RANDOM % 7 + 3))

          for i in $(seq 1 $COUNT); do
            F=${FILES[$RANDOM % ${#FILES[@]}]}
            M=${MSGS[$RANDOM % ${#MSGS[@]}]}
            echo "$(date) :: $RANDOM :: work" >> $F
            git add .
            git commit -m "$M" || true
            sleep $((RANDOM % 120 + 30))
          done

          git push || true

      # ----------------------
      # Branch + PR Flow
      # ----------------------
      - name: Branch Work
        if: steps.mode.outputs.MODE == 'branch_pr'
        run: |
          BR=feature-$RANDOM
          echo "BRANCH=$BR" >> $GITHUB_ENV
          git checkout -b $BR

          for i in {1..3}; do
            echo "feature block $RANDOM" >> feature_$i.txt
          done

          git add .
          git commit -m "feat: experimental module $BR"
          git push origin $BR

      - name: Create PR
        if: steps.mode.outputs.MODE == 'branch_pr'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Feature $BRANCH" \
            --body "Automated feature improvement batch" \
            --base main \
            --head $BRANCH || true

      # ----------------------
      # Issue Engine
      # ----------------------
      - name: Issue Create
        if: steps.mode.outputs.MODE == 'issue'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TITLES=(
            "Improve logging layer"
            "Add validation guard"
            "Refactor config loader"
            "Optimize parser path"
          )

          T=${TITLES[$RANDOM % ${#TITLES[@]}]}

          NUM=$(gh issue create \
            --title "$T" \
            --body "Planned internal enhancement" \
            --json number -q .number)

          # 40% chance auto close
          if [ $((RANDOM % 10)) -lt 4 ]; then
            gh issue close $NUM
          fi

      # ----------------------
      # Alt Account Review + Merge
      # ----------------------
      - name: Alt Review + Merge
        if: steps.mode.outputs.MODE == 'branch_pr'
        env:
          GH_TOKEN: ${{ secrets.ALT_TOKEN }}
        run: |
          PR=$(gh pr list --limit 1 --json number -q '.[0].number')
          if [ "$PR" != "" ]; then
            gh pr review $PR --approve || true
            gh pr merge $PR --squash --delete-branch || true
          fi

      # ----------------------
      # Cooldown Delay
      # ----------------------
      - name: Cooldown Delay
        run: sleep $((RANDOM % 900))
