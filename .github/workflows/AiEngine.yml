name: AiEngine

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  human-sim:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------
      # Install tools
      # ----------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq gh

      # ----------------------
      # Git identity
      # ----------------------
      - name: Git identity
        run: |
          git config --global user.name "dragaditya"
          git config --global user.email "waghaditya312@gmail.com"

      # ----------------------
      # Ensure files
      # ----------------------
      - name: Ensure Files
        run: |
          [ -f ai.py ] || echo 'print("hello")' > ai.py
          [ -f utils.js ] || echo 'console.log("hi")' > utils.js
          [ -f config.json ] || echo '{}' > config.json
          [ -f notes.md ] || echo 'notes' > notes.md
          [ -f README.md ] || echo '# Repo' > README.md

      # ----------------------
      # README placeholder
      # ----------------------
      - name: Fix README
        run: |
          if ! grep -q AI_ENGINE_STATS_START README.md; then
            echo "" >> README.md
            echo "## ðŸ¤– AI Engine Stats" >> README.md
            echo "<!-- AI_ENGINE_STATS_START -->" >> README.md
            echo "Loading..." >> README.md
            echo "<!-- AI_ENGINE_STATS_END -->" >> README.md
          fi

      # ----------------------
      # Init CSV
      # ----------------------
      - name: Init CSV
        run: |
          [ -f AI_ENGINE.csv ] || echo "DATE,TIME,MODE,COMMITS,FILES,PUSH" > AI_ENGINE.csv

      # ----------------------
      # Work hour check (IST)
      # ----------------------
      - name: Work Hour Check
        run: |
          HOUR=$(TZ="Asia/Kolkata" date +%H)
          if [ "$HOUR" -lt 9 ] || [ "$HOUR" -gt 23 ]; then
            exit 0
          fi

      # ----------------------
      # Lazy mode
      # ----------------------
      - name: Lazy Mode
        id: lazy
        run: |
          if [ $((RANDOM % 10)) -lt 2 ]; then
            echo "$(TZ='Asia/Kolkata' date '+%F'),$(TZ='Asia/Kolkata' date '+%H:%M'),lazy,0,-,-" >> AI_ENGINE.csv
            echo "lazy=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "lazy=false" >> $GITHUB_OUTPUT

      # ----------------------
      # Mode select
      # ----------------------
      - name: Select Mode
        id: mode
        if: steps.lazy.outputs.lazy == 'false'
        run: |
          R=$((RANDOM % 100))

          if [ "$R" -lt 30 ]; then MODE="commit";
          elif [ "$R" -lt 55 ]; then MODE="branch_pr";
          else MODE="issue"; fi

          echo "mode=$MODE" >> $GITHUB_OUTPUT

      # ----------------------
      # Commit mode
      # ----------------------
      - name: Commit Mode
        if: steps.mode.outputs.mode == 'commit'
        run: |
          git pull --rebase || true

          FILES=("ai.py" "utils.js" "config.json" "notes.md")

          COMMITS=0
          FILE_EDITED=""

          for i in 1 2; do
            IDX=$((RANDOM % 4))
            F=${FILES[$IDX]}

            echo "// tweak $RANDOM" >> "$F"
            FILE_EDITED="$FILE_EDITED|$F"

            git add "$F"

            if ! git diff --cached --quiet; then
              git commit -m "minor tweak"
              COMMITS=$((COMMITS+1))
            fi
          done

          git push || true

          echo "$(TZ='Asia/Kolkata' date '+%F'),$(TZ='Asia/Kolkata' date '+%H:%M'),commit,$COMMITS,$FILE_EDITED,OK" >> AI_ENGINE.csv

      # ----------------------
      # Branch + PR
      # ----------------------
      - name: Branch PR
        if: steps.mode.outputs.mode == 'branch_pr'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git pull --rebase || true

          BRANCH="feature-$(date +%s)-$RANDOM"
          git checkout -b "$BRANCH"

          echo "console.log('update');" >> mod.js
          git add mod.js
          git commit -m "flow update"
          git push origin "$BRANCH"

          gh pr create \
            --title "Auto PR" \
            --body "AI improvement" \
            --base main \
            --head "$BRANCH" || echo "PR failed"

          echo "$(TZ='Asia/Kolkata' date '+%F'),$(TZ='Asia/Kolkata' date '+%H:%M'),PR,1,mod.js,OK" >> AI_ENGINE.csv

      # ----------------------
      # Issue mode
      # ----------------------
      - name: Issue Mode
        if: steps.mode.outputs.mode == 'issue'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --title "Auto improvement" \
            --body "Planned by AI" || echo "Issue failed"

          echo "$(TZ='Asia/Kolkata' date '+%F'),$(TZ='Asia/Kolkata' date '+%H:%M'),issue,0,-,-" >> AI_ENGINE.csv

      # ----------------------
      # Update README
      # ----------------------
      - name: Update README
        run: |
          TOTAL_COMMITS=$(awk -F, 'NR>1{sum+=$4} END{print sum+0}' AI_ENGINE.csv)
          TOTAL_PR=$(grep -c ',PR,' AI_ENGINE.csv || true)
          TOTAL_ISSUE=$(grep -c ',issue,' AI_ENGINE.csv || true)
          TOTAL_LAZY=$(grep -c ',lazy,' AI_ENGINE.csv || true)

          sed -i '/AI_ENGINE_STATS_START/,/AI_ENGINE_STATS_END/d' README.md

          echo "<!-- AI_ENGINE_STATS_START -->" >> README.md
          echo "## ðŸ¤– AI Engine Stats" >> README.md
          echo "Last Update: $(TZ='Asia/Kolkata' date)" >> README.md
          echo "- Total Commits: $TOTAL_COMMITS" >> README.md
          echo "- Total PRs: $TOTAL_PR" >> README.md
          echo "- Total Issues: $TOTAL_ISSUE" >> README.md
          echo "- Lazy Runs: $TOTAL_LAZY" >> README.md
          echo "<!-- AI_ENGINE_STATS_END -->" >> README.md

      # ----------------------
      # Push updates
      # ----------------------
      - name: Push Updates
        run: |
          git add .
          git commit -m "AI engine update" || true
          git push || true
