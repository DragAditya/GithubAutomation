name: Ultra Activity Engine PRO

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  ultra:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Git Identity
        run: |
          git config --global user.name "dragaditya"
          git config --global user.email "waghaditya312@gmail.com"

      # ----------------------
      # Fast Warmup
      # ----------------------
      - run: sleep $((RANDOM % 600))

      # ----------------------
      # Mode Select
      # ----------------------
      - id: mode
        run: |
          MODE="branch_pr"
          echo "MODE=$MODE" >> $GITHUB_OUTPUT

      # ----------------------
      # Smart Commit Message Generator
      # ----------------------
      - name: Build Message Pool
        run: |
          VERB=(improve refactor optimize adjust simplify harden)
          NOUN=(parser config loader validation flow handler module)
          MSG="${VERB[$RANDOM%6]} ${NOUN[$RANDOM%7]} logic"
          echo "MSG=$MSG" >> $GITHUB_ENV

      # ----------------------
      # Self Tests (Repo Sanity)
      # ----------------------
      - name: Repo Self Test
        run: |
          test -f README.md || echo "# Auto README" > README.md
          test -d .github || mkdir .github
          echo "Self-test passed"

      # ----------------------
      # Stats Init
      # ----------------------
      - name: Init Stats
        run: |
          if [ ! -f activity_stats.json ]; then
            echo '{"runs":0,"commit":0,"pr":0,"issue":0}' > activity_stats.json
          fi

      # ----------------------
      # Commit Mode
      # ----------------------
      - name: Commit Mode
        if: steps.mode.outputs.MODE == 'commit'
        run: |
          COUNT=$((RANDOM % 5 + 3))
          for i in $(seq 1 $COUNT); do
            echo "$(date) :: $RANDOM" >> dev_trace.txt
            git add .
            git commit -m "$MSG" || true
            sleep $((RANDOM % 30 + 15))
          done

          jq '.runs+=1 | .commit+=1' activity_stats.json > tmp.json && mv tmp.json activity_stats.json

          echo "$(date '+%F %H:%M') | MODE=commit | count=$COUNT" >> logs.txt

          git add .
          git commit -m "log+stats: commit mode" || true
          git push || true

      # ----------------------
      # Branch + PR Mode
      # ----------------------
      - name: Branch Work
        if: steps.mode.outputs.MODE == 'branch_pr'
        run: |
          BR=feature-$RANDOM
          echo "BRANCH=$BR" >> $GITHUB_ENV
          git checkout -b $BR
          echo "$RANDOM feature work" >> feature.txt
          git add .
          git commit -m "$MSG"
          git push origin $BR

      - name: Create PR
        if: steps.mode.outputs.MODE == 'branch_pr'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create --title "$MSG" --body "auto improvement" --base main --head $BRANCH || true

      - name: Alt Review Merge
        if: steps.mode.outputs.MODE == 'branch_pr'
        env:
          GH_TOKEN: ${{ secrets.ALT_TOKEN }}
        run: |
          PR=$(gh pr list --limit 1 --json number -q '.[0].number')
          if [ "$PR" != "" ]; then
            gh pr review $PR --approve || true
            gh pr merge $PR --squash --delete-branch || true
          fi

          jq '.runs+=1 | .pr+=1' activity_stats.json > tmp.json && mv tmp.json activity_stats.json
          echo "$(date '+%F %H:%M') | MODE=pr | branch=$BRANCH" >> logs.txt

          git add .
          git commit -m "log+stats: pr mode" || true
          git push || true

      # ----------------------
      # Issue Mode
      # ----------------------
      - name: Issue Mode
        if: steps.mode.outputs.MODE == 'issue'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NUM=$(gh issue create --title "$MSG" --body "auto task" --json number -q .number)

          ACTION="open"
          if [ $((RANDOM%2)) -eq 0 ]; then
            gh issue close $NUM
            ACTION="open+close"
          fi

          jq '.runs+=1 | .issue+=1' activity_stats.json > tmp.json && mv tmp.json activity_stats.json

          echo "$(date '+%F %H:%M') | MODE=issue | action=$ACTION | id=$NUM" >> logs.txt

          git add .
          git commit -m "log+stats: issue mode" || true
          git push || true

      # ----------------------
      # Weekly Report
      # ----------------------
      - name: Weekly Report
        run: |
          DAY=$(date +%u)
          if [ "$DAY" = "7" ]; then
            echo "# Weekly Activity Report" > weekly-report.md
            cat activity_stats.json >> weekly-report.md
            git add weekly-report.md
            git commit -m "weekly report update" || true
            git push || true
          fi

      # ----------------------
      # Fast Cooldown
      # ----------------------
      - run: sleep $((RANDOM % 300))
